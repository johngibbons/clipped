<%= image_tag @user.avatar.url(:large), :id => "cropbox" %>

<script>
var ratio = <%= @user.ratio %>;
var crop_x = <%= @user.crop_x %> / ratio;
var crop_y = <%= @user.crop_y %> / ratio;
var crop_w = <%= @user.crop_w %> / ratio;
var crop_h = <%= @user.crop_h %> / ratio;
function update_crop(coords) {
	console.log(coords);
  var rx = 150/coords.w;
  var ry = 150/coords.h;
  $('#previewHolder').css({
    width: Math.round(rx * <%= @user.avatar_geometry(:large).width %>) + 'px',
    height: Math.round(ry * <%= @user.avatar_geometry(:large).height %>) + 'px',
    marginLeft: '-' + Math.round(rx * coords.x) + 'px',
    marginTop: '-' + Math.round(ry * coords.y) + 'px'
  });

  	crop_x = coords.x;
		crop_y = coords.y;
		crop_w = coords.w;
		crop_h = coords.h;
	}

	$(document).ready(function() {
		$("#edit-crop").click(function() {
			$("#profile-preview").html("<%= j(image_tag @user.avatar.url(:large), id: "previewHolder") %>")
			$("#profile-preview").addClass("avatar");
			$("#profile-preview").css("box-sizing", "content-box");
		  $('#cropbox').Jcrop({
		    onChange: update_crop,
		    onSelect: update_crop,
		    setSelect: [ crop_x, crop_y, crop_x + crop_w, crop_y + crop_h],
		    aspectRatio: 1
		  });
    $(".jcrop-holder").show();
  	});

  	$("#submit-crop").click(function() {
  		$('#crop_x').val(Math.floor(crop_x * ratio));
		  $('#crop_y').val(Math.floor(crop_y * ratio));
		  $('#crop_w').val(Math.floor(crop_w * ratio));
		  $('#crop_h').val(Math.floor(crop_h * ratio));  
  	});
	});

</script>