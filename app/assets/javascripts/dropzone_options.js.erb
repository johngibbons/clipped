$('.uploads.new').ready(function () {

	deleteNextIteration = true;

  function formatTags(tag_input_field) {
  	console.log("format");
    $(tag_input_field).on('focusout',function(){    
      var txt= this.value.replace(/[^a-zA-Z0-9\+\-\.\#\s]/g,''); // allowed characters
      if(txt) {
        $(this).before('<span class="temporary tag"><span class="tag-data">'+ txt.toLowerCase() + '</span>' + '<span class="delete-tag fa fa-remove"></span></span>');
      }
      this.value="";
      }).on('keyup',function( e ){
      // if: comma,enter (delimit more keyCodes with | pipe)
      if(/^188$/.test(e.which)) {
        if(e.keyCode == 13) {
          e.preventDefault;
          return false;
        }
        $(this).focusout(); 
      }

      else if((e.which && e.which == 13) || (e.keyCode && e.keyCode == 13)) {
        $('button[type=submit] .default').click();
        return false;
      }
      else if(/^8$/.test(e.which)) {
        if(deleteNextIteration) {
          $('.tag').last().remove();
        }
      }

      if($(this).val().length == 0 ) {
        deleteNextIteration = true;
      }
      else {
        deleteNextIteration = false;
      }
    });
  };

 	// disable auto discover
	Dropzone.autoDiscover = false;

 	var dropzone = new Dropzone( ".dropzone", {
		maxFilesize: 50, // Set the maximum file size to 50 MB
		maxThumbnailFilesize: 50,
		paramName: "file", // Rails expects the file upload to be something like model[field_name]
		addRemoveLinks: false, // Don't show remove links on dropzone itself.
		acceptedFiles: 'image/*',
		dictDefaultMessage: "Drag Images or Click Here to Upload",
		clickable: "#clickable",
		thumbnailHeight: 210,
		thumbnailWidth: null,
		previewTemplate: document.querySelector('#preview-template').innerHTML,
		previewsContainer: "#upload-previews"
	});

	// Update the total progress bar
	dropzone.on("totaluploadprogress", function(progress) {
	  $('.dz-upload').width = progress + "%";
	});

	dropzone.on("addedfile", function() {
		$(".dz-message, #clickable").hide();
  	$("#uploader-controls").removeClass("hidden");
  	$("#remove-all-uploads").removeClass("hidden");
	});

	dropzone.on("sending", function(file, xhr, formData) {
	  // Will send the content type along with the file as POST data.
	  formData.append("Content-Type", file.type);
	});

  return dropzone.on("success", function(file, responseText) {
  	var direct_url = $(responseText).find("location")[0];
  	var url_location = $(direct_url).text();
  	$("#save-uploads").removeClass("hidden");

  	formatTags("upload_tag_list");

	  $("#save-uploads").click(function() {
	    $.post( "/uploads", { upload: {direct_upload_url: url_location} });
	  });

	  $("#remove-all-uploads").click(function() {
	  	dropzone.removeAllFiles(true);
	  });
  });

  

});